# 🔐 Next.js + FastAPI 認証デモアプリケーション

## 📝 プロジェクト概要

このプロジェクトは、Next.js (TypeScript) とFastAPIを使用した、セキュリティを重視した認証システムのデモンストレーションです。7つの重要なセキュリティ対策を実装しています。

## ✨ 主な機能

- ユーザー登録
- ログイン/ログアウト
- 認証が必要なダッシュボード
- 包括的なセキュリティ対策

## 🛡️ セキュリティ対策: 詳細説明

### 1. パスワード保護
**実装場所:**
- `security.py` の `SecurityManager` クラス
- `schemas.py` の `UserCreate` クラスのバリデーター

**具体的な仕組み:**
- パスワードは「bcrypt」というアルゴリズムでハッシュ化（暗号化）して保存
- ソルト（塩）と呼ばれるランダムな文字列をパスワードに追加してからハッシュ化
- パスワードの複雑さチェック（8文字以上、大文字小文字数字記号を含む）

**やさしい説明:**
パスワードを平文（そのまま）で保存すると、データベースが盗まれたときに全ユーザーのパスワードが漏れてしまいます。このアプリではパスワードを特殊な方法で「変換」して保存します。例えば「Password123!」が「$2b$12$X7.....」のような文字列になります。この変換は一方通行で、元に戻せません。ログイン時には入力されたパスワードも同じ方法で変換して、保存されたものと比較します。また、「abc123」のような簡単なパスワードは使えないようにチェックします。

### 2. トークン管理
**実装場所:**
- `security.py` の `TokenManager` クラス
- `main.py` の `/login` と `/refresh-token` エンドポイント

**具体的な仕組み:**
- JWT (JSON Web Token) による認証システム
- アクセストークンに30分の有効期限を設定
- トークンの署名検証による改ざん防止

**やさしい説明:**
ログインした後は、アプリがあなたに「トークン」という特別なIDカードを渡します。このカードはJWT（ジェイダブリューティー）と呼ばれる技術で作られています。あなたがサイト内のページに行くたびに、このIDカードを見せて「私は本当にログインした人です」と証明します。このカードには賞味期限（30分）があり、期限が切れると新しいカードをもらう必要があります。また、このカードは特殊な「署名」がついていて、誰かが勝手に作ったり変更したりすることはできません。

### 3. ブルートフォース攻撃対策
**実装場所:**
- `security.py` の `BruteForceDefender` クラス
- `main.py` の `/login` エンドポイント
- `models.py` の `User` モデルの `login_attempts` と `is_locked` フィールド

**具体的な仕組み:**
- IPアドレスごとのログイン試行回数を記録
- 5回連続失敗すると15分間のロックアウト
- ユーザーアカウントレベルでもロック機能を実装

**やさしい説明:**
パスワードを何度も間違えて入力すると、「ちょっと待って！」とアプリが止めます。例えば5回間違えると、15分間ログインできなくなります。これは「総当たり攻撃」と呼ばれる方法からアカウントを守るためです。総当たり攻撃とは、ロボットが自動的に何千もの異なるパスワードを次々と試す攻撃方法です。このアプリはIPアドレス（あなたのインターネット上の住所）ごとに試行回数を記録して、連続して間違えるとロックします。

### 4. XSS (クロスサイトスクリプティング) 対策
**実装場所:**
- `main.py` の `add_security_headers` ミドルウェア
- `security.py` の `secure_headers` オブジェクト
- フロントエンドの React（自動エスケープ）

**具体的な仕組み:**
- コンテンツセキュリティポリシー (CSP) ヘッダーの設定
- 入力データの検証とサニタイズ
- Reactのエスケープ機能による出力のエンコード

**やさしい説明:**
XSSとは、悪意のあるコード（スクリプト）をウェブサイトに忍び込ませる攻撃です。例えば、コメント欄に「こんにちは」ではなく、悪いプログラムコードを書き込むと、そのページを見た人のブラウザで勝手にプログラムが動いてしまうことがあります。このアプリでは特別な「セキュリティヘッダー」と呼ばれる指示を使って、ブラウザに「信頼できるコードだけを実行してね」と伝えます。また、ユーザーからの入力は全て「無害化」して安全に表示するようにしています。

### 5. CSRF (クロスサイトリクエストフォージェリ) 対策
**実装場所:**
- `security.py` の `generate_csrf_token` 関数
- フロントエンドの認証リクエスト処理

**具体的な仕組み:**
- ランダムなCSRFトークンの生成
- 重要な操作（ログイン、パスワード変更など）での検証
- SameSite Cookie属性の利用

**やさしい説明:**
CSRFは「なりすまし」のような攻撃です。例えば、あなたが銀行のサイトにログインしている間に、悪意のあるサイトを開くと、そのサイトがこっそり銀行サイトに「お金を送金して」というリクエストを送ることがあります。このアプリでは、重要な操作（ログインなど）ごとに「秘密のコード」を生成して、リクエストが本当にあなたのブラウザから来ているのかを確認します。これは、銀行の取引で本人確認のために電話やSMSで送られてくる確認コードのようなものです。

### 6. 安全な通信
**実装場所:**
- `main.py` の CORS設定
- フロントエンドの Axios設定

**具体的な仕組み:**
- 厳格なCORS（オリジン間リソース共有）ポリシー
- HTTPS通信を前提とした設計
- 通信内容の暗号化

**やさしい説明:**
インターネット上での通信は、道路を走る車のようなものです。普通の道路（HTTP）では、誰かがあなたの車（データ）の中身を覗いたり、途中で中身をすり替えたりする可能性があります。このアプリでは「HTTPS」という特別な暗号化された道路を使うことを想定して設計されています。また、「CORS」という仕組みで、あなたのデータが信頼できないサイトに送られることを防ぎます。これは、あなたの手紙が承認された住所にだけ配達されるようにする郵便システムのようなものです。

### 7. データベースセキュリティ
**実装場所:**
- `database.py` の SQLAlchemy ORM設定
- `models.py` の `User` モデル
- `main.py` のデータベース操作部分

**具体的な仕組み:**
- SQLインジェクション対策としてのORM使用
- パラメータ化クエリの使用
- データベース接続情報の安全な管理

**やさしい説明:**
データベースは、アプリの大切な情報が保管される「倉庫」のようなものです。SQLインジェクションは、この倉庫に不正な「指示」を送り込んで、情報を盗んだり壊したりする攻撃です。このアプリでは「ORM」という特別なプログラムを使って、データベースとやり取りします。これは「通訳」のような役割をして、悪意のある指示が直接データベースに届かないようにします。さらに、データベースへの指示を送る際には「パラメータ化クエリ」という安全な方法を使い、ユーザーの入力とプログラムの指示を明確に分けています。

## 🔍 セキュリティ対策の実際の動作確認方法

### パスワード保護を確認する
1. 登録画面で「abc123」のような簡単なパスワードを入力してみてください
2. 「パスワードは最低8文字で、大文字、小文字、数字、特殊文字を含む必要があります」というエラーが表示されます
3. データベース（`auth_demo.db`）を直接見ると、パスワードがハッシュ化されて保存されていることがわかります

### ブルートフォース攻撃対策を確認する
1. 存在するユーザーで意図的に間違ったパスワードを5回連続で入力してみてください
2. 5回目の失敗後、「アカウントは一時的にロックされています」というメッセージが表示されます

### トークン管理を確認する
1. ログインして、開発者ツール（F12）の「Application」または「Storage」タブでローカルストレージを確認します
2. `accessToken`という項目が保存されているはずです
3. [jwt.io](https://jwt.io/)にこのトークンを貼り付けると、内容（ユーザーIDなど）と有効期限が確認できます

## 🚀 技術スタック

### バックエンド
- FastAPI
- SQLAlchemy
- SQLite
- Python-jose (JWT)
- Passlib (パスワードハッシュ)

### フロントエンド
- Next.js
- TypeScript
- Tailwind CSS
- Axios
- React Hook Form

## 📦 インストール方法

### 前提条件
- Python 3.8+
- Node.js 14+
- pip
- npm

### バックエンドのセットアップ

1. リポジトリをクローン
```bash
git clone https://github.com/fumifumi0831/next-fastapi-auth-sample.git
cd next-fastapi-auth-sample/backend
```

2. 仮想環境の作成と有効化
```bash
# Windowsの場合
python -m venv venv
venv\Scripts\activate

# Mac/Linuxの場合
python3 -m venv venv
source venv/bin/activate
```

3. 依存関係のインストール
```bash
pip install -r requirements.txt
```

4. サーバーの起動
```bash
python main.py
```

### フロントエンドのセットアップ

1. 別のターミナルで以下を実行
```bash
cd ../frontend
npm install
npm run dev
```

## 🖥️ アプリケーションへのアクセス

- バックエンド: `http://localhost:8000`
- フロントエンド: `http://localhost:3000`

## 🧪 テスト

### バックエンドテスト
```bash
# バックエンドディレクトリで
pytest
```

### フロントエンドテスト
```bash
# フロントエンドディレクトリで
npm test
```

## 🔒 本番環境への注意点

- 環境変数の適切な管理
- 本番用のシークレットキーの使用
- HTTPS環境での運用
- 継続的なセキュリティアップデート

## 🤝 コントリビューション

1. フォーク
2. フィーチャーブランチの作成 (`git checkout -b feature/AmazingFeature`)
3. 変更をコミット (`git commit -m 'Add some AmazingFeature'`)
4. ブランチにプッシュ (`git push origin feature/AmazingFeature`)
5. プルリクエストを作成

## 📄 ライセンス

このプロジェクトは MIT ライセンスの下で提供されています。詳細は `LICENSE` ファイルを参照してください。

## 💡 免責事項

このデモアプリケーションは教育目的で作成されています。本番環境での使用には、さらなるセキュリティ強化と専門家のレビューが必要です。

## 🌟 サポート

問題や機能リクエストがある場合は、GitHubの Issues セクションに投稿してください。

---

🔐 セキュリティは継続的な学習と改善の旅です。常に最新の知識とベストプラクティスを学び続けましょう！
